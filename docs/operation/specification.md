<!--Meta
category:系统运维
title:规范
DO NOT Delete Meta Above -->

# 完整流程

## 开发

#### 按照要求组织代码

图片/css/js分目录存放

等等

#### 在分配的测试机器上测试

## 内测

#### 内测是正式上线的演练

#### 项目经理决定开始进入内测阶段,通知开发/测试/运维做准备

- 开发人员准备好部署文档

- 分配测试服务器(虚拟机或Docker容器,当前为虚拟机)

- 按照部署文档在测试服务器上部署

- 根据部署效果反馈开发人员修改部署文档

- 建立内网域名映射,使用测试服务器测试

- 测试人员测试通过后通知项目经理

## 上线

#### 新网站

- 网站测试通过后由项目经理通知开发及运维进入上线阶段

- 按照内测的步骤上线

- 修改内网域名映射,指向公网服务器

- 测试人员测试通过后通知运维

- 申请公网域名指向,启用新网站

#### 现有网站bug修复

- 在内测服务器上测试完成后测试人员通知项目经理

- 运维人员使用自动化上线设置选择预先安排的时间(周二至周四均可)上线新代码

- 或者在周二至周四的早上(8点之前)手动上线新代码

# 开发&测试

## 代码规划

### 代码按照域名划分目录

- 按照网站的主域名如www/blog/wiki等来划分目录

- 静态文件的域名按照主域名进行合并

- 静态文件单独存放,便于后期的cdn部署及静态资源域名绑定

### 文件编码

- 所有代码均要求文件编码为不带BOM的UTF-8编码文件,框架或依赖也要尽量符合要求

### 数据库

- 数据库不能使用root用户

- 单独项目使用单独数据库及相关用户

- 数据库编码要求使用UTF-8

## 配置要求

### 多套hosts文件更新来进行多域名的测试

- 由于可能开发多域名网站,开发人员需要在本地配有多套hosts文件,在开发和测试的时候进行替换

- 使用虚拟机或Docker也是不错的方案

### 代码内的地址使用域名,本地配置hosts文件

- 为了减少由于开发环境与测试环境的差异导致的配置信息更改，所有的地址都尽量使用域名，而不是IP来访问，包括数据库的链接地址

- 通过本地的hosts来配置具体的IP

### 使用第三方框架的时候去掉框架信息

- 即curl -I返回结果中 X-Powered-By 字段不要出现或内容为空

## 性能要求

### 文件组织

- CSS放在页首,JS放在页尾

- 大图片尽量不要放在第一屏，而且可以使用延迟加载的技术载入

- 若可能，尽量将总是一起出现的CSS打包成一个文件，一起出现的JS打包成一个文件

### 减少小图片

- 将小图片(小于5KB)合并为一张大图,使用css sprite技术

### 不要在代码中使用动态程序来处理统计信息

- 使用静态文件+日志解析的方式来进行访问统计

- 外部统计一般都是放在页面底部，而且要通过一个不可见的DIV将其包含起来

## 安全要求

### 尽量减少不必要的端口需求

- 如非必要,不要开放socket服务,尽量使用微服务的方式来提供功能,以减少代码漏洞导致服务器被黑的可能

### 文件及文件夹权限

- 正常情况下文件均需要为 0600 或 0644 权限,所有者和属组在部署后均为 www-data 用户

- 目录则为 0700 或 0755 权限, 所有者和属组在部署后均为 www-data 用户

- 如果因为框架原因要求某文件/目录为特殊权限,首先需要开发看能否更改框架来调整该文件权限,确实无法调整的,部署的时候需要单独说明

# 上线

## 流程安排

### 上线之前的通知

上线必须让产品经理、运维人员和开发人员 *事先* 都知晓而且同意，而且必须要有产品经理与开发人员撰写的变更项说明，以及运维人员参与编写的部署说明

### 上线时间

上线不能安排在周一，避免开发人员忘记之前的工作内容，也不能安排在周五，以免上线出现问题后没有人可以及时解决，因此上线时间只能安排在周三左右

## 对开发的要求

### 提供部署说明文档

#### 系统环境需求(nginx/php/mysql)

#### 运行依赖

php-mcrypt之类需要的模块

#### 代码依赖

composer install 或 gom install 等 (此处如果能够提供独立的依赖包或依赖包含在代码里更好)

#### 配置

数据库配置/.env配置(laravel框架)/其他配置(各种框架)

#### 其他

### 更新网站

需要开发人员提供变更说明,以及相对应的依赖关系/配置文件等的变动

## 对运维的要求

### 上线自动化

上线尽量安排在网站流量最少的时候(一般是4点左右)，以避免文件更新不一致导致用户看到错位的页面，这也要求我们上线要自动化

### 准备

上线之前做好流量预估，这样好预先分配带宽，流量可以从历史访问记录来计算(旧网站)，或者上线之前先分配一个猜测带宽，再时刻准备好随时申请新带宽，同样的道理也适用于其他的动态资源(CPU与内存)预估

如果上线的是一个新域名，用来替换旧域名网站的，需要将原域名的URL以一种方式映射到新域名的网站来(比如使用nginx的rewrite功能)，当然，这种映射应该进行时常的检查，定期去掉已经没有人访问的链接，还有尽量手功能修改外部链接的就修改外部链接。原链接的来源可以来自于对原网站最近一段时间的日志的分析，获取外部网站对原网站最频繁的依赖。还需要向市场宣传的同事了解外部的广告宣传链接、友情链接或者内部的频道链接，以避免出现空链或者搜索引擎降权

每次上线都要保证外部统计都与原来的统计代码一致

### 配置

#### nginx

- 每个网站使用独立目录存放日志, 日志定时压缩转储, 远程保存日志(TODO)

#### 数据库

- 关闭远程访问(默认行为)

- 建库使用utf-8

#### 代码存放

- /var/www/www.deepin.org 以网站名为目录存放

- /var/www/assets/www.deepin.org 资源文件存放方式

